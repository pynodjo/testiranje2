<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pojedinaƒçna pretraga</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <!-- Search Forms Container -->
    <div class="container">
        <h1>Pretraga aktivnih kupaca</h1>

        <!-- ≈†ifra Search -->
        <form id="sifra-form" class="search-form">
            <label for="sifra">Pretraga po ≈°ifri mjernog mjesta:</label>
            <input type="text" id="sifra" name="sifra" placeholder="Unesite ≈°ifru mjernog mjesta">
            <button type="submit">Pretraga</button>
            <div id="sifra-error" class="validation-error"></div>
        </form>
        <div id="result-sifra" class="result"></div>

        <!-- Serijski Broj Search -->
        <form id="serijski_broj-form" class="search-form">
            <label for="serijski_broj">Pretraga po serijskom broju brojila:</label>
            <input type="text" id="serijski_broj" name="serijski_broj" placeholder="Unesite serijski broj brojila">
            <button type="submit">Pretraga</button>
            <div id="serijski-broj-error" class="validation-error"></div>
        </form>
        <div id="result-serijski_broj" class="result"></div>

        <!-- Customer Search -->
        <form id="kupac-form">
            <label for="kupac">Pretraga po nazivu kupca:</label>
            <div class="search-wrapper"> <!-- wrap input -->
                <input type="text" id="kupac" name="kupac" autocomplete="off">
                <div id="kupac-suggestions" class="autocomplete-suggestions"></div>
            </div>
            <button type="submit">Pretraga</button>
        </form>
        <div id="result-kupac" class="result"></div>
        <button class="bottom-button" onclick="location.reload();">Osvje≈æi</button>
    </div>

    <div style="height: 20px;"></div>

    <!-- Geographic Display by OH -->
    <div class="container">
        <h1>Geografski prikaz mm po OH</h1>
        <select id="oj-dropdown">
            <option value="">--Odaberite OJ--</option>
            <option value="301">PJD Mostar</option>
            <option value="302">PJD Konjic</option>
            <option value="303">PJD Jablanica</option>
        </select>
        <select id="oh-dropdown" disabled>
            <option value="">--Odaberite OH--</option>
        </select>
        <button id="search-button-oh" disabled>Pretraga</button>
        <div id="status-oh"></div>
        <div id="map-container-OH"></div>
        <button class="bottom-button" onclick="location.reload();">Osvje≈æi</button>
    </div>

    <div style="height: 20px;"></div>

    <!-- Geographic Display by TS -->
    <div class="container">
        <h1>Geografski prikaz mm po TS</h1>
        <div class="search-container">
            <input type="text" id="ts-search" placeholder="Pretra≈æi trafostanice..." class="search-input">
            <select id="ts-naziv-dropdown" size="5" class="searchable-dropdown">
                <option value="">--Odaberite Trafostanicu (TS_NAZIV)--</option>
            </select>
        </div>
        <button id="search-button-ts">Pretraga</button>
        <div id="status-ts"></div>
        <div id="map-container-TSMM"></div>
        <button class="bottom-button" onclick="location.reload();">Osvje≈æi</button>
    </div>

    <div style="height: 20px;"></div>

    <!-- Trafostanica Search -->
    <div class="container">
        <h1>Pretraga podataka trafostanica</h1>
        <form id="trafostanica-form">
            <label for="trafostanica">Pretraga po nazivu trafostanice:</label>
            <div class="search-wrapper">
                <input type="text" id="trafostanica" name="trafostanica" placeholder="Unesite naziv trafostanice">
                <div id="trafostanica-suggestions" class="suggestions-container"></div>
            </div>
            <button type="submit">Pretraga</button>
            <div id="trafostanica-error" class="validation-error"></div>
        </form>
        <div id="result-trafostanica" class="result"></div>
        <button class="bottom-button" onclick="location.reload();">Osvje≈æi</button>
    </div>

    <div style="height: 20px;"></div>

    <!-- Rastavljaƒç Search -->
    <div class="container">
        <h1>Pretraga rastavljaƒça</h1>
        <form id="rastavljac-form">
            <label for="rastavljac">Pretraga po nazivu ili ≈°ifri rastavljaƒça:</label>
            <div class="search-wrapper">
                <input type="text" id="rastavljac" name="rastavljac" placeholder="Unesite naziv ili ≈°ifru (min 3 znaka)">
                <div id="rastavljac-suggestions" class="suggestions-container"></div>
            </div>
            <button type="submit">Pretraga</button>
            <div id="rastavljac-error" class="validation-error"></div>
        </form>
        <div id="result-rastavljac" class="result"></div>
        <button class="bottom-button" onclick="location.reload();">Osvje≈æi</button>
    </div>

    <!-- All Trafostanice Map -->
    <div class="container">
        <h1>Geografski prikaz svih trafostanica</h1>
        <button id="view-all-btn" class="map-button">Prika≈æi sve trafostanice na mapi</button>
        <div id="status-trafostanica"></div>
        <div id="map-container-trafostanica"></div>
        <button class="bottom-button" onclick="location.reload();">Osvje≈æi</button>
    </div>

    <!-- PDF Downloads -->
    <div class="container" style="margin-top:20px;">
        <h1>Jednopolne sheme PJD</h1>
        <p>Preuzmite sheme (PDF):</p>
        <ul class="list-unstyled">
            <li><button class="bottom-button" onclick="location.href='{{ url_for('static', filename='pdfs/Jednopolna_shema_PJD_Mostar.pdf') }}'">Jednopolna shema PJD Mostar</button></li>
            <li><button class="bottom-button" onclick="location.href='{{ url_for('static', filename='pdfs/Jednopolna_shema_PJD_Konjic.pdf') }}'">Jednopolna shema PJD Konjic</button></li>
            <li><button class="bottom-button" onclick="location.href='{{ url_for('static', filename='pdfs/Jednopolna_shema_PJD_Jablanica.pdf') }}'">Jednopolna shema PJD Jablanica</button></li>
        </ul>
    </div>

    <!-- Footer -->
    <div class="footer">
        <p>¬© ED Mostar 2025</p>
        <small>A≈æurirano 15.10.2025.</small>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    
    <script>
        // ==============================================
        // UTILITY FUNCTIONS
        // ==============================================
        
        const Utils = {
            // Sanitize HTML to prevent XSS
            escapeHtml: (text) => {
                const map = {
                    '&': '&amp;',
                    '<': '&lt;',
                    '>': '&gt;',
                    '"': '&quot;',
                    "'": '&#039;'
                };
                return text ? String(text).replace(/[&<>"']/g, m => map[m]) : 'N/A';
            },

            // Debounce function
            debounce: (func, wait) => {
                let timeout;
                return function executedFunction(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), wait);
                };
            },

            // Validation
            showValidationError: (inputId, errorId, message) => {
                document.getElementById(inputId).classList.add('field-error');
                document.getElementById(errorId).textContent = message;
            },

            clearValidationError: (inputId, errorId) => {
                document.getElementById(inputId).classList.remove('field-error');
                document.getElementById(errorId).textContent = '';
            },

            // Create result table HTML
            createResultTable: (data) => {
                const info = data.additional_info || {};
                return `
                    <table>
                        ${data.url ? `<tr><td class="bold-header">Lokacija:</td><td><a href="${Utils.escapeHtml(data.url)}" target="_blank">Google Maps link</a></td></tr>` : ''}
                        <tr><td class="bold-header">Kupac:</td><td>${Utils.escapeHtml(info['Kupac'])}</td></tr>
                        <tr><td class="bold-header">Adresa:</td><td>${Utils.escapeHtml(info['Adresa'])}</td></tr>
                        <tr><td class="bold-header">Tip brojila:</td><td>${Utils.escapeHtml(info['Tip brojila'])}</td></tr>
                        <tr><td class="bold-header">Godina ba≈ædarenja:</td><td>${Utils.escapeHtml(info['Godina ba≈ædarenja'])}</td></tr>
                        <tr><td class="bold-header">Godina proizvodnje:</td><td>${Utils.escapeHtml(info['Godina proizvodnje'])}</td></tr>
                        <tr><td class="bold-header">Datum monta≈æe:</td><td>${Utils.escapeHtml(info['Datum monta≈æe'])}</td></tr>
                        <tr><td class="bold-header">Serijski broj brojila:</td><td>${Utils.escapeHtml(info['Serijski broj brojila'])}</td></tr>
                        <tr><td class="bold-header">≈†ifra mjernog mjesta:</td><td>${Utils.escapeHtml(info['≈†ifra mjernog mjesta'])}</td></tr>
                        <tr><td class="bold-header">Tarifna grupa:</td><td>${Utils.escapeHtml(info['Tarifna grupa'])}</td></tr>
                        <tr><td class="bold-header">Anga≈æovana snaga:</td><td>${Utils.escapeHtml(info['Anga≈æovana snaga'])}</td></tr>
                        <tr><td class="bold-header">Naziv trafostanice:</td><td>${Utils.escapeHtml(info['Naziv trafostanice'])}</td></tr>
                    </table>
                `;
            }
        };

        // ==============================================
        // MAP MANAGER
        // ==============================================
        
        const MapManager = {
            maps: {},

            createMap: (containerId, center = [43.3438, 17.8078], zoom = 13) => {
                // Clean up existing map
                if (MapManager.maps[containerId]) {
                    MapManager.maps[containerId].remove();
                }

                const map = L.map(containerId).setView(center, zoom);
                MapManager.maps[containerId] = map;

                const baseMaps = {
                    "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        maxZoom: 18,
                        attribution: 'Tiles &copy; Esri'
                    }),
                    "OpenStreetMap": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        maxZoom: 21,
                        attribution: '¬© OpenStreetMap contributors'
                    })
                };

                baseMaps["Satellite"].addTo(map);
                L.control.layers(baseMaps, null, { position: 'topright' }).addTo(map);
                L.control.scale().addTo(map);

                return map;
            },

            addFullscreenControl: (map, containerId) => {
                const fullscreenButton = L.control({ position: 'topright' });
                
                fullscreenButton.onAdd = function () {
                    const btn = L.DomUtil.create('button', 'custom-fullscreen-btn');
                    btn.innerHTML = 'üóñ';
                    btn.title = 'View Fullscreen';
                    
                    btn.onclick = function() {
                        const elem = document.getElementById(containerId);
                        if (!document.fullscreenElement) {
                            elem.requestFullscreen?.() || elem.webkitRequestFullscreen?.();
                            btn.innerHTML = 'üóó';
                        } else {
                            document.exitFullscreen?.() || document.webkitExitFullscreen?.();
                            btn.innerHTML = 'üóñ';
                        }
                    };
                    
                    return btn;
                };
                
                fullscreenButton.addTo(map);
            },

            createMarkerCluster: () => {
                return L.markerClusterGroup({
                    showCoverageOnHover: true,
                    zoomToBoundsOnClick: true,
                    spiderfyOnMaxZoom: true,
                    removeOutsideVisibleBounds: true,
                    maxClusterRadius: 40,
                    spiderfyDistanceMultiplier: 1.5,
                    disableClusteringAtZoom: 22,
                    chunkedLoading: true,
                    iconCreateFunction: function(cluster) {
                        const count = cluster.getChildCount();
                        const size = count < 10 ? 30 : count < 100 ? 35 : 40;
                        return L.divIcon({
                            html: `<div><span>${count}</span></div>`,
                            className: 'marker-cluster-custom',
                            iconSize: L.point(size, size)
                        });
                    }
                });
            }
        };

        // ==============================================
        // SEARCH HANDLERS
        // ==============================================
        
        const SearchHandlers = {
            handleSimpleSearch: (formId, inputId, errorId, endpoint, validationRegex = /^[0-9]+$/) => {
                document.getElementById(formId).addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const value = document.getElementById(inputId).value.trim();
                    
                    if (!value) {
                        Utils.showValidationError(inputId, errorId, 'Molimo unesite vrijednost.');
                        return;
                    }
                    
                    if (!validationRegex.test(value)) {
                        Utils.showValidationError(inputId, errorId, 'Unos mo≈æe sadr≈æavati samo brojeve.');
                        return;
                    }
                    
                    Utils.clearValidationError(inputId, errorId);
                    
                    try {
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: `${inputId}=${encodeURIComponent(value)}`
                        });
                        
                        const data = await response.json();
                        const resultDiv = document.getElementById(`result-${inputId}`);
                        
                        if (data.url || Object.keys(data.additional_info || {}).length > 0) {
                            resultDiv.innerHTML = Utils.createResultTable(data);
                            if (!data.url) {
                                resultDiv.innerHTML = '<p class="error">Lokacija nije pronaƒëena, ali su sljedeƒái podaci dostupni:</p>' + resultDiv.innerHTML;
                            }
                        } else {
                            resultDiv.innerHTML = '<p>Podaci nisu pronaƒëeni u bazi podataka.</p>';
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        document.getElementById(`result-${inputId}`).innerHTML = '<p>Gre≈°ka prilikom pretrage.</p>';
                    }
                });
            },

            setupAutocomplete: (inputId, suggestionsId, endpoint, minChars = 3) => {
                const input = document.getElementById(inputId);
                const container = document.getElementById(suggestionsId);
                
                const fetchSuggestions = Utils.debounce(async (value) => {
                    if (value.length < minChars) {
                        container.style.display = 'none';
                        return;
                    }
                    
                    try {
                        const formData = new FormData();
                        formData.append('input', value);
                        
                        const response = await fetch(endpoint, {
                            method: 'POST',
                            body: formData
                        });
                        
                        const data = await response.json();
                        const suggestions = data.suggestions || data;
                        
                        container.innerHTML = '';
                        if (suggestions.length > 0) {
                            suggestions.forEach(suggestion => {
                                const div = document.createElement('div');
                                div.textContent = typeof suggestion === 'string' ? suggestion : 
                                    `${suggestion.kupac} (${suggestion.serijski}, ${suggestion.adresa})`;
                                div.className = 'suggestion-item';
                                div.onclick = () => {
                                    input.value = div.textContent;
                                    container.style.display = 'none';
                                };
                                container.appendChild(div);
                            });
                            container.style.display = 'block';
                        } else {
                            container.style.display = 'none';
                        }
                    } catch (error) {
                        console.error('Error fetching suggestions:', error);
                        container.style.display = 'none';
                    }
                }, 300);
                
                input.addEventListener('input', (e) => fetchSuggestions(e.target.value.trim()));
                
                document.addEventListener('click', (e) => {
                    if (!input.contains(e.target) && !container.contains(e.target)) {
                        container.style.display = 'none';
                    }
                });
            }
        };

        // ==============================================
        // INITIALIZATION
        // ==============================================
        
        document.addEventListener('DOMContentLoaded', () => {
            // Setup simple searches
            SearchHandlers.handleSimpleSearch('sifra-form', 'sifra', 'sifra-error', '/get_coordinates_by_sifra');
            SearchHandlers.handleSimpleSearch('serijski_broj-form', 'serijski_broj', 'serijski-broj-error', '/get_coordinates_by_serijski_broj');
            
            // Setup autocomplete
            SearchHandlers.setupAutocomplete('kupac', 'kupac-suggestions', '/get_customer_suggestions');
            SearchHandlers.setupAutocomplete('trafostanica', 'trafostanica-suggestions', '/get_trafostanica_suggestions');
            SearchHandlers.setupAutocomplete('rastavljac', 'rastavljac-suggestions', '/get_rastavljac_suggestions');
            

            // Kupac form submission
            document.getElementById('kupac-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const inputValue = document.getElementById('kupac').value.trim();

                // Expecting input format: "KupacName (Serijski, Adresa)"
                const match = inputValue.match(/^(.*?)\s*\((\d+),/);

                if (!match) {
                    document.getElementById('result-kupac').innerHTML = 
                        '<p class="error">Neva≈æeƒái unos. Molimo odaberite kupca iz ponuƒëene liste.</p>';
                    return;
                }

                const kupacName = match[1].trim();
                const serijski = match[2];

                try {
                    const response = await fetch('/get_coordinates_by_kupac', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `kupac=${encodeURIComponent(kupacName)}&serijski=${encodeURIComponent(serijski)}`
                    });

                    const data = await response.json();

                    document.getElementById('result-kupac').innerHTML = 
                        data.error ? `<p class="error">${data.error}</p>` : Utils.createResultTable(data);

                } catch (error) {
                    console.error('Error during fetch:', error);
                    document.getElementById('result-kupac').innerHTML = 
                        '<p class="error">Gre≈°ka prilikom pretrage.</p>';
                }
            });
 

            // Trafostanica form
            document.getElementById('trafostanica-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const value = document.getElementById('trafostanica').value.trim();
                
                try {
                    const response = await fetch('/get_trafostanica_data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ trafostanica: value })
                    });
                    
                    const data = await response.json();
                    const resultDiv = document.getElementById('result-trafostanica');
                    
                    if (data.google_maps_url) {
                        const d = data;
                        resultDiv.innerHTML = `
                            <table>
                                <tr><td class="bold-header">Lokacija:</td><td><a href="${Utils.escapeHtml(d.google_maps_url)}" target="_blank">Google Maps link</a></td></tr>
                                <tr><td class="bold-header">Naziv trafostanice:</td><td>${Utils.escapeHtml(d.naziv)}</td></tr>
                                <tr><td class="bold-header">Snaga:</td><td>${d.snaga ? Utils.escapeHtml(d.snaga) + ' kVA' : 'N/A'}</td></tr>
                                <tr><td class="bold-header">Broj transformatora:</td><td>${Utils.escapeHtml(d.broj_transformatora)}</td></tr>
                                <tr><td class="bold-header">Konfiguracija SN postrojenja:</td><td>${Utils.escapeHtml(d.konfiguracija_SN_postrojenja)}</td></tr>
                                <tr><td class="bold-header">Napojna trafostanica:</td><td>${Utils.escapeHtml(d.napojna_trafostanica)}</td></tr>
                                <tr><td class="bold-header">Naziv SN odlaza:</td><td>${Utils.escapeHtml(d.naziv_SN_odlaza)}</td></tr>
                                <tr><td class="bold-header">Tip trafostanice:</td><td>${Utils.escapeHtml(d.tip_trafostanice)}</td></tr>
                                <tr><td class="bold-header">Poslovnica:</td><td>${Utils.escapeHtml(d.poslovnica)}</td></tr>
                                <tr><td class="bold-header">Tip Kuƒái≈°ta:</td><td>${Utils.escapeHtml(d.tip_kucista)}</td></tr>
                                <tr><td class="bold-header">Tip izolacije:</td><td>${Utils.escapeHtml(d.tip_izolacije)}</td></tr>
                                <tr><td class="bold-header">Vlasnik:</td><td>${Utils.escapeHtml(d.vlasnik)}</td></tr>
                                <tr><td class="bold-header">Godina izgradnje:</td><td>${Utils.escapeHtml(d.godina_izgradnje)}</td></tr>
                            </table>
                        `;
                    } else {
                        resultDiv.innerHTML = `<p class="error">${data.error || 'Podaci nisu pronaƒëeni.'}</p>`;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    document.getElementById('result-trafostanica').innerHTML = '<p class="error">Gre≈°ka prilikom pretrage.</p>';
                }
            });

            // Rastavljac form
            document.getElementById('rastavljac-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const value = document.getElementById('rastavljac').value.trim();
                
                if (!value) {
                    document.getElementById('rastavljac-error').textContent = 'Unesite naziv ili ≈°ifru rastavljaƒça.';
                    return;
                }
                document.getElementById('rastavljac-error').textContent = '';
                
                try {
                    const response = await fetch('/get_rastavljac_data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ rastavljac: value })
                    });
                    
                    const data = await response.json();
                    const resultDiv = document.getElementById('result-rastavljac');
                    
                    if (data.google_maps_url) {
                        const d = data;
                        resultDiv.innerHTML = `
                            <table>
                                <tr><td class="bold-header">Lokacija:</td><td><a href="${Utils.escapeHtml(d.google_maps_url)}" target="_blank">Google Maps link</a></td></tr>
                                <tr><td class="bold-header">Naziv (NTS/SNO):</td><td>${Utils.escapeHtml(d.naziv)}</td></tr>
                                <tr><td class="bold-header">≈†ifra:</td><td>${Utils.escapeHtml(d.sifra)}</td></tr>
                                <tr><td class="bold-header">PJ:</td><td>${Utils.escapeHtml(d.pj)}</td></tr>
                                <tr><td class="bold-header">Vrsta upravljanja:</td><td>${Utils.escapeHtml(d.vrsta_upravljanja)}</td></tr>
                                <tr><td class="bold-header">SNO naziv:</td><td>${Utils.escapeHtml(d.sno_naziv)}</td></tr>
                                <tr><td class="bold-header">DSN:</td><td>${Utils.escapeHtml(d.dsn)}</td></tr>
                                <tr><td class="bold-header">DSN naziv:</td><td>${Utils.escapeHtml(d.dsn_naziv)}</td></tr>
                            </table>
                        `;
                    } else {
                        resultDiv.innerHTML = `<p class="error">${data.error || 'Podaci nisu pronaƒëeni.'}</p>`;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    document.getElementById('result-rastavljac').innerHTML = '<p class="error">Gre≈°ka prilikom pretrage.</p>';
                }
            });

            // OJ/OH Dropdowns
            const ojDropdown = document.getElementById('oj-dropdown');
            const ohDropdown = document.getElementById('oh-dropdown');
            const searchButtonOH = document.getElementById('search-button-oh');
            
            ojDropdown.addEventListener('change', async () => {
                const oj = ojDropdown.value;
                ohDropdown.innerHTML = '<option value="">--Odaberite OH--</option>';
                ohDropdown.disabled = true;
                searchButtonOH.disabled = true;
                
                if (!oj) return;
                
                try {
                    const response = await fetch(`/get_oh_values_by_oj/${oj}`);
                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error);
                    
                    data.forEach(oh => {
                        const option = document.createElement('option');
                        option.value = oh;
                        option.textContent = oh;
                        ohDropdown.appendChild(option);
                    });
                    
                    ohDropdown.disabled = false;
                } catch (error) {
                    console.error('Error:', error);
                    document.getElementById('status-oh').textContent = `Gre≈°ka: ${error.message}`;
                }
            });
            
            ohDropdown.addEventListener('change', () => {
                searchButtonOH.disabled = !ohDropdown.value;
            });
            
            searchButtonOH.addEventListener('click', async () => {
                const oj = ojDropdown.value;
                const oh = ohDropdown.value;
                const container = document.getElementById('map-container-OH');
                const status = document.getElementById('status-oh');
                
                try {
                    status.textContent = 'Uƒçitavanje mape...';
                    container.innerHTML = '<div id="map-oh" style="height: 500px;"></div>';
                    
                    const response = await fetch(`/search_by_oj_oh?oj=${oj}&oh=${oh}`);
                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error);
                    
                    const map = MapManager.createMap('map-oh', data.center);
                    MapManager.addFullscreenControl(map, 'map-oh');
                    
                    const markers = MapManager.createMarkerCluster();
                    data.features.forEach(feature => {
                        const coords = feature.geometry.coordinates;
                        const props = feature.properties;
                        const popup = `
                            <div style="font-family: Arial, sans-serif; min-width: 200px;">
                                <h4>Detalji mjernog mjesta</h4>
                                <p><strong>Kupac:</strong> ${Utils.escapeHtml(props.IME_PREZIME)}</p>
                                <p><strong>Adresa:</strong> ${Utils.escapeHtml(props.ADRESA_MM)}</p>
                                <p><strong>≈†ifra:</strong> ${Utils.escapeHtml(props.SIFRA)}</p>
                                <p><strong>Serijski broj:</strong> ${Utils.escapeHtml(props.SERIJSKI)}</p>
                                <p><strong>Tip:</strong> ${Utils.escapeHtml(props.TIP)}</p>
                                <p><strong>ROH:</strong> ${Utils.escapeHtml(props.ROH)}</p>
                                <p><strong>Anga≈æovana snaga:</strong> ${Utils.escapeHtml(props.ANG_SNAGA)}</p>
                            </div>
                        `;
                        markers.addLayer(L.marker([coords[1], coords[0]]).bindPopup(popup));
                    });
                    
                    map.addLayer(markers);
                    status.textContent = `Prikazano ${data.features.length} lokacija.`;
                } catch (error) {
                    console.error('Error:', error);
                    status.textContent = `Gre≈°ka: ${error.message}`;
                }
            });

            // TS Search
            let allTsValues = [];
            const tsSearch = document.getElementById('ts-search');
            const tsDropdown = document.getElementById('ts-naziv-dropdown');
            const searchButtonTS = document.getElementById('search-button-ts');
            
            fetch('/get_ts_naziv_values')
                .then(r => r.json())
                .then(data => {
                    allTsValues = data;
                    data.forEach(value => {
                        const option = document.createElement('option');
                        option.value = value;
                        option.textContent = value;
                        tsDropdown.appendChild(option);
                    });
                })
                .catch(err => console.error('Error loading TS values:', err));
            
            tsSearch.addEventListener('input', Utils.debounce((e) => {
                const term = e.target.value.toLowerCase();
                const filtered = term.length >= 2 ? allTsValues.filter(v => v.toLowerCase().includes(term)) : allTsValues;
                
                tsDropdown.innerHTML = '<option value="">--Odaberite Trafostanicu--</option>';
                filtered.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    tsDropdown.appendChild(option);
                });
            }, 300));
            
            tsDropdown.addEventListener('change', () => {
                searchButtonTS.disabled = !tsDropdown.value;
                if (tsDropdown.value) tsSearch.value = tsDropdown.value;
            });
            
            searchButtonTS.addEventListener('click', async () => {
                const tsNaziv = tsDropdown.value;
                if (!tsNaziv) return;
                
                const container = document.getElementById('map-container-TSMM');
                const status = document.getElementById('status-ts');
                
                try {
                    status.textContent = 'Uƒçitavanje mape...';
                    container.innerHTML = '<div id="map-tsmm" style="height: 500px;"></div>';
                    
                    const response = await fetch(`/filter_data_by_ts_naziv?ts_naziv=${encodeURIComponent(tsNaziv)}`);
                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error);
                    
                    const map = MapManager.createMap('map-tsmm', data.center);
                    MapManager.addFullscreenControl(map, 'map-tsmm');
                    
                    const markers = MapManager.createMarkerCluster();
                    data.features.forEach(feature => {
                        const coords = feature.geometry.coordinates;
                        const props = feature.properties;
                        const popup = `
                            <div style="font-family: Arial, sans-serif; min-width: 200px;">
                                <h4>Detalji mjernog mjesta</h4>
                                <p><strong>Kupac:</strong> ${Utils.escapeHtml(props.IME_PREZIME)}</p>
                                <p><strong>Adresa:</strong> ${Utils.escapeHtml(props.ADRESA_MM)}</p>
                                <p><strong>≈†ifra:</strong> ${Utils.escapeHtml(props.SIFRA)}</p>
                                <p><strong>Serijski broj:</strong> ${Utils.escapeHtml(props.SERIJSKI)}</p>
                                <p><strong>Tip:</strong> ${Utils.escapeHtml(props.TIP)}</p>
                                <p><strong>Anga≈æovana snaga:</strong> ${Utils.escapeHtml(props.ANG_SNAGA)}</p>
                            </div>
                        `;
                        markers.addLayer(L.marker([coords[1], coords[0]]).bindPopup(popup));
                    });
                    
                    map.addLayer(markers);
                    status.textContent = 'Mapa uspje≈°no uƒçitana.';
                } catch (error) {
                    console.error('Error:', error);
                    status.textContent = `Gre≈°ka: ${error.message}`;
                }
            });

            // View All Trafostanice
            document.getElementById('view-all-btn').addEventListener('click', async () => {
                const container = document.getElementById('map-container-trafostanica');
                const status = document.getElementById('status-trafostanica');
                
                try {
                    status.textContent = 'Uƒçitavanje mape...';
                    container.innerHTML = '<div id="map-all-trafo" style="height: 500px;"></div>';
                    
                    const response = await fetch('/view_all_trafostanice');
                    const data = await response.json();
                    
                    if (data.error) throw new Error(data.error);
                    
                    const map = MapManager.createMap('map-all-trafo', data.center, 11);
                    MapManager.addFullscreenControl(map, 'map-all-trafo');
                    
                    const markers = MapManager.createMarkerCluster();
                    data.features.forEach(feature => {
                        const coords = feature.geometry.coordinates;
                        const props = feature.properties;
                        const popup = `
                            <div style='min-width: 200px'>
                                <b>Naziv:</b> ${Utils.escapeHtml(props.naziv)}<br>
                                <b>Snaga:</b> ${Utils.escapeHtml(props.snaga)} kVA
                            </div>
                        `;
                        markers.addLayer(L.marker([coords[1], coords[0]]).bindPopup(popup).bindTooltip(props.naziv));
                    });
                    
                    map.addLayer(markers);
                    status.textContent = 'Mapa uspje≈°no uƒçitana.';
                } catch (error) {
                    console.error('Error:', error);
                    status.textContent = `Gre≈°ka: ${error.message}`;
                }
            });
        });
    </script>
</body>
</html>